import streamlit as st
from app.sidebar_manager import SidebarManager
from streamlit_drawable_canvas import st_canvas
import tempfile
from datetime import date, timedelta
import pandas as pd
from PIL import Image, ImageDraw, ImageFont, ImageOps
import numpy as np
import datetime
import holidays
import img2pdf
import os
import io
import tempfile
import base64
import pathlib
import sys

# Cáº¥u hÃ¬nh trang Streamlit
st.set_page_config(
    page_title="ÄÆ¡n ÄÄƒng KÃ½ Há»c",  # TiÃªu Ä‘á» trang
    layout="wide",  # Bá»‘ cá»¥c rá»™ng
    initial_sidebar_state="expanded"  # Sidebar má»Ÿ máº·c Ä‘á»‹nh
)

# Render sidebar (Quáº£n lÃ½ Sidebar)
sidebar = SidebarManager()
sidebar.render_sidebar()

class ResourceManager:
    def __init__(self):
        self.base_dir = self.get_absolute_path()
        self.image_dir = self.base_dir / "images"
        self.font_dir = self.base_dir / "fonts"

        # Thiáº¿t láº­p Ä‘Æ°á»ng dáº«n file
        self.paths = {
            "ì‹ ì²­ì„œ ì–‘ì‹": self.image_dir / "studywork001.png",  # "Máº«u Ä‘Æ¡n Ä‘Äƒng kÃ½": Ä‘Æ°á»ng dáº«n Ä‘áº¿n hÃ¬nh áº£nh máº«u Ä‘Æ¡n Ä‘Äƒng kÃ½
            "ë³„ì§€ ì–‘ì‹": self.image_dir / "studywork002.png",  # "Máº«u phá»¥ lá»¥c": Ä‘Æ°á»ng dáº«n Ä‘áº¿n hÃ¬nh áº£nh máº«u phá»¥ lá»¥c (náº¿u cáº§n)
            "ë¡œê³ ": self.image_dir / "logo.png",  # "Logo": Ä‘Æ°á»ng dáº«n Ä‘áº¿n hÃ¬nh áº£nh logo trÆ°á»ng
            "í°íŠ¸": self.font_dir / "AppleGothic.ttf"  # "PhÃ´ng chá»¯": Ä‘Æ°á»ng dáº«n Ä‘áº¿n file phÃ´ng chá»¯
        }

    @staticmethod
    def get_absolute_path():
        """Láº¥y Ä‘Æ°á»ng dáº«n tuyá»‡t Ä‘á»‘i cho á»©ng dá»¥ng."""
        if os.path.exists("/mount/src/study-work"):
            return pathlib.Path("/mount/src/study-work")
        elif os.path.exists("/workspaces/Study-work"):
            return pathlib.Path("/workspaces/Study-work")
        else:
            return pathlib.Path(__file__).parent.parent.resolve()

    def get_font_path(self):
        """TÃ¬m vÃ  tráº£ vá» Ä‘Æ°á»ng dáº«n file phÃ´ng chá»¯."""
        if self.paths["í°íŠ¸"].exists():
            return str(self.paths["í°íŠ¸"])

        # Thay vÃ¬ duyá»‡t `system_font_paths`, ta cÃ³ thá»ƒ kiá»ƒm tra xem biáº¿n nÃ y cÃ³ tá»“n táº¡i hay khÃ´ng
        # vÃ  sá»­ dá»¥ng má»™t danh sÃ¡ch cÃ¡c Ä‘Æ°á»ng dáº«n font há»‡ thá»‘ng máº·c Ä‘á»‹nh
        system_font_paths = [
            "/usr/share/fonts/truetype/nanum/NanumGothic.ttf",  # Linux (Nanum Gothic)
            "/Library/Fonts/Arial Unicode.ttf",  # macOS (Arial Unicode)
            "C:\\Windows\\Fonts\\arial.ttf"  # Windows (Arial)
        ]

        for system_font in system_font_paths:
            if os.path.exists(system_font):
                return system_font

        st.error("KhÃ´ng tÃ¬m tháº¥y file phÃ´ng chá»¯.")
        st.info("HÃ£y cÃ i Ä‘áº·t phÃ´ng chá»¯ NanumGothic hoáº·c thÃªm file phÃ´ng chá»¯ vÃ o thÆ° má»¥c fonts.")
        st.stop()

    def validate_resources(self):
        """Kiá»ƒm tra tÃ­nh há»£p lá»‡ cá»§a file tÃ i nguyÃªn."""
        for name, path in self.paths.items():
            if name != "í°íŠ¸" and not path.exists():
                st.error(f"KhÃ´ng tÃ¬m tháº¥y {name}. ÄÆ°á»ng dáº«n: {path}")
                st.stop()

        self.font_path = self.get_font_path()

    def print_debug_info(self):
        """In thÃ´ng tin debug."""
        st.write("ThÃ´ng tin Ä‘Æ°á»ng dáº«n hiá»‡n táº¡i:")
        st.write(f"BASE_DIR: {self.base_dir}")
        st.write(f"IMAGE_DIR: {self.image_dir}")
        st.write(f"FONT_DIR: {self.font_dir}")
        st.write(f"ÄÆ°á»ng dáº«n phÃ´ng chá»¯ Ä‘ang sá»­ dá»¥ng: {self.font_path}")

# Táº¡o instance ResourceManager
resources = ResourceManager()

# In thÃ´ng tin debug (náº¿u cáº§n)
if os.getenv('STREAMLIT_DEBUG') == 'true':
    resources.print_debug_info()

# Kiá»ƒm tra tÃ i nguyÃªn
resources.validate_resources()

# Thiáº¿t láº­p Ä‘Æ°á»ng dáº«n toÃ n cá»¥c
BASE_DIR = resources.base_dir
IMAGE_DIR = resources.image_dir
FONT_DIR = resources.font_dir
img_path = resources.paths["ì‹ ì²­ì„œ ì–‘ì‹"]
extra_img_path = resources.paths["ë³„ì§€ ì–‘ì‹"]
logo_path = resources.paths["ë¡œê³ "]
font_path = resources.font_path

# In Ä‘Æ°á»ng dáº«n Ä‘á»ƒ debug
if os.getenv('STREAMLIT_DEBUG') == 'true':
    st.write(f"""
    ÄÆ°á»ng dáº«n Ä‘Ã£ thiáº¿t láº­p:
    - ÄÆ°á»ng dáº«n cÆ¡ sá»Ÿ: {BASE_DIR}
    - ÄÆ°á»ng dáº«n áº£nh: {IMAGE_DIR}
    - ÄÆ°á»ng dáº«n phÃ´ng chá»¯: {FONT_DIR}
    - Máº«u Ä‘Æ¡n Ä‘Äƒng kÃ½: {img_path}
    - Máº«u phá»¥ lá»¥c: {extra_img_path}
    - Logo: {logo_path}
    - PhÃ´ng chá»¯: {font_path}
    """)

# 1. Khá»Ÿi táº¡o tráº¡ng thÃ¡i phiÃªn
if 'student_canvas_key' not in st.session_state:
    st.session_state.student_canvas_key = 0
    st.session_state.student_canvas_initialized = False  # Cá» khá»Ÿi táº¡o
if 'guardian_canvas_key' not in st.session_state:
    st.session_state.guardian_canvas_key = 100
    st.session_state.guardian_canvas_initialized = False  # Cá» khá»Ÿi táº¡o
if 'student_signature_img' not in st.session_state:
    st.session_state.student_signature_img = None
if 'guardian_signature_img' not in st.session_state:
    st.session_state.guardian_signature_img = None

# Khá»Ÿi táº¡o phiÃªn cho bÆ°á»›c hiá»‡n táº¡i
if 'step' not in st.session_state:
    st.session_state.step = 1

# Khá»Ÿi táº¡o Ä‘á»ƒ lÆ°u káº¿ hoáº¡ch há»c táº­p tráº£i nghiá»‡m ngoÃ i trÆ°á»ng
if 'plans' not in st.session_state:
    st.session_state.plans = {}

# Hiá»ƒn thá»‹ tiÃªu Ä‘á» chÃ­nh
st.markdown("<h1 style='text-align: center;'>ÄÆ¡n ÄÄƒng KÃ½</h1>", unsafe_allow_html=True)

# Xá»­ lÃ½ áº£nh logo
def get_base64_image(image_path):
    try:
        with open(image_path, "rb") as img_file:
            encoded = base64.b64encode(img_file.read()).decode()
        return encoded
    except FileNotFoundError:
        return None

# Hiá»ƒn thá»‹ logo
logo_base64 = get_base64_image(logo_path) if logo_path.exists() else None

# Hiá»ƒn thá»‹ logo vÃ  tÃªn trÆ°á»ng (nhÆ° má»™t tiÃªu Ä‘á» phá»¥)
if logo_base64:
    st.markdown(f"""
        <div style="display: flex; align-items: center; justify-content: center;">
            <img src="data:image/png;base64,{logo_base64}" alt="Logo" style="margin-right: 10px; width: 40px; height: 40px;">
            <h3 style="margin: 0;">CÃ´ng Ty Eurofins VN</h3>
        </div>
    """, unsafe_allow_html=True)
else:
    st.markdown("<h3 style='text-align: center;'>CÃ´ng Ty Eurofins VN</h3>", unsafe_allow_html=True)

# Táº¡o cÃ¡c tab
tabs = st.tabs([
    "1. Nháº­p ThÃ´ng Tin Há»c Sinh",
    "2. ThÃ´ng Tin ÄÄƒng KÃ½",
    "3. Káº¿ Hoáº¡ch Há»c Táº­p",  # Pháº§n nháº­p báº£ng Excel
    "4. ThÃ´ng Tin NgÆ°á»i GiÃ¡m Há»™",
    "5. Nháº­p Chá»¯ KÃ½",
    "6. XÃ¡c Nháº­n ÄÆ¡n ÄÄƒng KÃ½"
])

# Tab 1: Nháº­p thÃ´ng tin há»c sinh
with tabs[0]:
    st.header("Nháº­p ThÃ´ng Tin Há»c Sinh")
    st.text_input('Há» vÃ  TÃªn', key='student_name')  # key duy nháº¥t
    st.selectbox('Lá»›p', ['Chá»n lá»›p', 'Lá»›p 10', 'Lá»›p 11', 'Lá»›p 12'], key='student_grade')
    st.selectbox('Tá»•', ['Chá»n tá»•'] + [f'Tá»• {i}' for i in range(1, 13)], key='student_class')
    st.number_input('Sá»‘ thá»© tá»±', min_value=1, max_value=50, step=1, key='student_number')

# Tab 2: Nháº­p thÃ´ng tin Ä‘Äƒng kÃ½
with tabs[1]:
    st.header("Nháº­p ThÃ´ng Tin ÄÄƒng KÃ½ Há»c Táº­p Tráº£i Nghiá»‡m NgoÃ i TrÆ°á»ng")

    # Hai cá»™t cho ngÃ y báº¯t Ä‘áº§u vÃ  ngÃ y káº¿t thÃºc
    col1, col2 = st.columns(2)
    with col1:
        # Loáº¡i bá» min_value vÃ  chá»‰ thiáº¿t láº­p giÃ¡ trá»‹ máº·c Ä‘á»‹nh
        start_date = st.date_input(
            'NgÃ y Báº¯t Äáº§u',
            value=date.today() + timedelta(days=1),  # Máº·c Ä‘á»‹nh lÃ  ngÃ y mai
            key='start_date'
        )
    with col2:
        # Thiáº¿t láº­p min_value lÃ  start_date
        end_date = st.date_input(
            'NgÃ y Káº¿t ThÃºc',
            value=start_date + timedelta(days=1),  # Máº·c Ä‘á»‹nh lÃ  ngÃ y sau ngÃ y báº¯t Ä‘áº§u
            min_value=start_date,
            key='end_date'
        )

    # ThÃªm giáº£i thÃ­ch cho ngÃ y báº¯t Ä‘áº§u/káº¿t thÃºc Ä‘Æ°á»£c cÃ´ng nháº­n
    st.markdown("""
    **HÆ°á»›ng dáº«n Nháº­p Khoáº£ng Thá»i Gian ÄÆ°á»£c CÃ´ng Nháº­n Äi Há»c**

    HÃ£y nháº­p khoáº£ng thá»i gian Ä‘Æ°á»£c cÃ´ng nháº­n Ä‘i há»c báº±ng cÃ¡ch loáº¡i trá»« 'ngÃ y lá»…' khá»i khoáº£ng thá»i gian há»c táº­p tráº£i nghiá»‡m ngoÃ i trÆ°á»ng.
    Náº¿u ngÃ y káº¿t thÃºc há»c táº­p tráº£i nghiá»‡m ngoÃ i trÆ°á»ng lÃ  'Chá»§ Nháº­t', hÃ£y nháº­p khoáº£ng thá»i gian Ä‘Æ°á»£c cÃ´ng nháº­n Ä‘i há»c Ä‘áº¿n 'Thá»© SÃ¡u'.
    """)

    # Hai cá»™t cho ngÃ y báº¯t Ä‘áº§u vÃ  ngÃ y káº¿t thÃºc Ä‘Æ°á»£c cÃ´ng nháº­n
    col3, col4 = st.columns(2)
    with col3:
        attendance_start_date = st.date_input(
            'NgÃ y Báº¯t Äáº§u ÄÆ°á»£c CÃ´ng Nháº­n',
            value=start_date,
            min_value=start_date,
            max_value=end_date,
            key='attendance_start_date'
        )
    with col4:
        attendance_end_date = st.date_input(
            'NgÃ y Káº¿t ThÃºc ÄÆ°á»£c CÃ´ng Nháº­n',
            value=attendance_start_date,
            min_value=attendance_start_date,
            max_value=end_date,
            key='attendance_end_date'
        )

    # Chá»n hÃ¬nh thá»©c há»c táº­p
    st.selectbox(
        'Chá»n HÃ¬nh Thá»©c Há»c Táº­p',
        ['Chá»n hÃ¬nh thá»©c há»c táº­p', 'Du lá»‹ch cÃ¹ng gia Ä‘Ã¬nh', 'Tham dá»± vÃ  thÄƒm viáº¿ng sá»± kiá»‡n gia Ä‘Ã¬nh', 'KhÃ¡m phÃ¡ di tÃ­ch', 'Du lá»‹ch vÄƒn há»c',
         'Tráº£i nghiá»‡m vÄƒn hÃ³a trong nÆ°á»›c vÃ  tháº¿ giá»›i', 'HÃ nh hÆ°Æ¡ng', 'KhÃ¡m phÃ¡ thiÃªn nhiÃªn', 'Tráº£i nghiá»‡m nghá» nghiá»‡p', 'KhÃ¡c'],
        key='learning_type'
    )

    # Nháº­p má»¥c Ä‘Ã­ch vÃ  Ä‘á»‹a Ä‘iá»ƒm
    st.text_input('Má»¥c ÄÃ­ch', key='purpose')
    st.text_input('Äá»‹a Äiá»ƒm', key='destination')

# Tab 3: Nháº­p Káº¿ hoáº¡ch há»c táº­p (thÃªm Ä‘á»™ng dá»±a trÃªn form)
with tabs[2]:
    st.header("Nháº­p Káº¿ Hoáº¡ch Há»c Táº­p Tráº£i Nghiá»‡m NgoÃ i TrÆ°á»ng")

    # ThÃªm Ä‘oáº¡n vÄƒn giáº£i thÃ­ch
    st.markdown('<p style="color: red; font-size: small;">Nháº­p lá»‹ch trÃ¬nh vÃ  nháº¥n nÃºt thÃªm Ä‘á»ƒ táº¡o káº¿ hoáº¡ch</p>', unsafe_allow_html=True)

    start_date = st.session_state.get('start_date')
    end_date = st.session_state.get('end_date')

    if start_date and end_date:
        # Táº¡o danh sÃ¡ch ngÃ y
        date_list = []
        current_date = start_date
        while current_date <= end_date:
            date_str = f"NgÃ y {(current_date - start_date).days + 1} ({current_date.strftime('%m/%d')})"
            date_list.append(date_str)
            current_date += timedelta(days=1)

        # Khá»Ÿi táº¡o plans
        if 'plans' not in st.session_state:
            st.session_state.plans = {}

        # Container cho form nháº­p
        with st.container():
            # Dropdown chá»n ngÃ y
            selected_date = st.selectbox(
                "Chá»n NgÃ y",
                date_list,
                key="selected_date"
            )

            # Widget chá»n thá»i gian
            col1, col2, col3 = st.columns(3)
            with col1:
                # Táº¡o cÃ¡c tÃ¹y chá»n thá»i gian (cÃ¡ch nhau 30 phÃºt)
                time_options = []
                for hour in range(24):
                    for minute in [0, 30]:
                        time_str = f"{hour:02d}:{minute:02d}"
                        time_options.append(time_str)

                # Thiáº¿t láº­p giÃ¡ trá»‹ máº·c Ä‘á»‹nh lÃ  9:00
                default_index = time_options.index("09:00")

                selected_time = st.selectbox(
                    "Thá»i Gian",
                    options=time_options,
                    index=default_index,
                    key="input_time"
                )

            with col2:
                location = st.text_input("Äá»‹a Äiá»ƒm", key="input_location")
            with col3:
                activity = st.text_input("Ná»™i Dung Hoáº¡t Äá»™ng", key="input_activity")

            # NÃºt thÃªm lá»‹ch trÃ¬nh
            if st.button("ThÃªm Lá»‹ch TrÃ¬nh"):
                day_key = selected_date.split()[0]  # TrÃ­ch xuáº¥t dáº¡ng "NgÃ y 1"

                if day_key not in st.session_state.plans:
                    st.session_state.plans[day_key] = []

                new_plan = {
                    "Thá»i Gian": selected_time,  # Sá»­ dá»¥ng trá»±c tiáº¿p thá»i gian Ä‘Ã£ chá»n
                    "Äá»‹a Äiá»ƒm": location,
                    "Ná»™i Dung Hoáº¡t Äá»™ng": activity
                }

                # ThÃªm lá»‹ch trÃ¬nh má»›i vÃ o káº¿ hoáº¡ch cá»§a ngÃ y Ä‘Ã³
                st.session_state.plans[day_key].append(new_plan)

                # Sáº¯p xáº¿p theo thá»i gian
                st.session_state.plans[day_key] = sorted(
                    st.session_state.plans[day_key],
                    key=lambda x: x['Thá»i Gian']
                )

                st.success(f"ÄÃ£ thÃªm lá»‹ch trÃ¬nh vÃ o {selected_date}.")

        # Hiá»ƒn thá»‹ lá»‹ch trÃ¬nh hiá»‡n táº¡i
        st.markdown("### Lá»‹ch TrÃ¬nh Hiá»‡n Táº¡i")

        if st.session_state.plans:
            # Chuáº©n bá»‹ dá»¯ liá»‡u cho dataframe
            df_data = []
            for day_key, plans in sorted(st.session_state.plans.items()):
                day_num = int(''.join(filter(str.isdigit, day_key)))
                current_date = start_date + timedelta(days=day_num - 1)
                date_str = current_date.strftime("%m/%d")

                # Sáº¯p xáº¿p káº¿ hoáº¡ch cá»§a má»—i ngÃ y theo thá»i gian
                sorted_plans = sorted(plans, key=lambda x: x['Thá»i Gian'])

                for plan in sorted_plans:
                    df_data.append({
                        "NgÃ y": f"{day_key} ({date_str})",
                        "Thá»i Gian": plan['Thá»i Gian'],
                        "Äá»‹a Äiá»ƒm": plan['Äá»‹a Äiá»ƒm'],
                        "Ná»™i Dung Hoáº¡t Äá»™ng": plan['Ná»™i Dung Hoáº¡t Äá»™ng']
                    })

            if df_data:
                df = pd.DataFrame(df_data)

                # PhÃ¢n tÃ¡ch hoÃ n toÃ n hiá»ƒn thá»‹ dataframe vÃ  UI xÃ³a
                if df_data:
                    # 1. Pháº§n hiá»ƒn thá»‹ DataFrame
                    if len(df) > 15:
                        df1 = df.iloc[:15]
                        df2 = df.iloc[15:]

                        col1, col2 = st.columns(2)
                        with col1:
                            st.dataframe(
                                df1,
                                hide_index=True,
                                column_config={
                                    "NgÃ y": st.column_config.TextColumn("NgÃ y", width="medium"),
                                    "Thá»i Gian": st.column_config.TextColumn("Thá»i Gian", width="small"),
                                    "Äá»‹a Äiá»ƒm": st.column_config.TextColumn("Äá»‹a Äiá»ƒm", width="medium"),
                                    "Ná»™i Dung Hoáº¡t Äá»™ng": st.column_config.TextColumn("Ná»™i Dung Hoáº¡t Äá»™ng", width="large"),
                                }
                            )
                        with col2:
                            st.dataframe(
                                df2,
                                hide_index=True,
                                column_config={
                                    "NgÃ y": st.column_config.TextColumn("NgÃ y", width="medium"),
                                    "Thá»i Gian": st.column_config.TextColumn("Thá»i Gian", width="small"),
                                    "Äá»‹a Äiá»ƒm": st.column_config.TextColumn("Äá»‹a Äiá»ƒm", width="medium"),
                                    "Ná»™i Dung Hoáº¡t Äá»™ng": st.column_config.TextColumn("Ná»™i Dung Hoáº¡t Äá»™ng", width="large"),
                                }
                            )
                    else:
                        st.dataframe(
                            df,
                            hide_index=True,
                            column_config={
                                "NgÃ y": st.column_config.TextColumn("NgÃ y", width="medium"),
                                "Thá»i Gian": st.column_config.TextColumn("Thá»i Gian", width="small"),
                                "Äá»‹a Äiá»ƒm": st.column_config.TextColumn("Äá»‹a Äiá»ƒm", width="medium"),
                                "Ná»™i Dung Hoáº¡t Äá»™ng": st.column_config.TextColumn("Ná»™i Dung Hoáº¡t Äá»™ng", width="large"),
                            }
                        )

                    # 2. Pháº§n UI xÃ³a (tÃ¡ch biá»‡t trong container riÃªng)
                    with st.container():
                        st.markdown("---")  # ÄÆ°á»ng phÃ¢n cÃ¡ch
                        st.markdown("### XÃ³a Lá»‹ch TrÃ¬nh")

                        # Chá»n lá»‹ch trÃ¬nh Ä‘á»ƒ xÃ³a
                        delete_options = [f"{plan['NgÃ y']} - {plan['Thá»i Gian']} - {plan['Äá»‹a Äiá»ƒm']} - {plan['Ná»™i Dung Hoáº¡t Äá»™ng']}" for plan in df_data]
                        selected_plan_to_delete = st.selectbox(
                            "Chá»n Lá»‹ch TrÃ¬nh Muá»‘n XÃ³a",
                            delete_options,
                            key="selected_plan_to_delete"
                        )

                        # NÃºt xÃ³a vÃ  logic
                        if st.button("XÃ³a Lá»‹ch TrÃ¬nh ÄÃ£ Chá»n", key="delete_plan_button"):
                            day_info = selected_plan_to_delete.split(" - ")[0]
                            time_info = selected_plan_to_delete.split(" - ")[1]
                            day_key = day_info.split(" ")[0]

                            if day_key in st.session_state.plans:
                                st.session_state.plans[day_key] = [
                                    plan for plan in st.session_state.plans[day_key]
                                    if plan['Thá»i Gian'] != time_info
                                ]

                                if not st.session_state.plans[day_key]:
                                    del st.session_state.plans[day_key]

                                st.success("ÄÃ£ xÃ³a lá»‹ch trÃ¬nh Ä‘Ã£ chá»n.")
                                st.rerun()
                else:
                    st.info("KhÃ´ng cÃ³ lá»‹ch trÃ¬nh nÃ o Ä‘Æ°á»£c Ä‘Äƒng kÃ½.")

            else:
                st.warning("HÃ£y thiáº¿t láº­p ngÃ y báº¯t Ä‘áº§u vÃ  ngÃ y káº¿t thÃºc há»c táº­p tráº£i nghiá»‡m ngoÃ i trÆ°á»ng.")

    else:
        st.warning("HÃ£y thiáº¿t láº­p ngÃ y báº¯t Ä‘áº§u vÃ  ngÃ y káº¿t thÃºc há»c táº­p tráº£i nghiá»‡m ngoÃ i trÆ°á»ng.")

# Tab Nháº­p thÃ´ng tin ngÆ°á»i giÃ¡m há»™
with tabs[3]:
    st.header("Nháº­p ThÃ´ng Tin NgÆ°á»i GiÃ¡m Há»™")

    # ThÃ´ng tin ngÆ°á»i giÃ¡m há»™
    col1, col2, col3 = st.columns(3)
    with col1:
        guardian_name = st.text_input('TÃªn NgÆ°á»i GiÃ¡m Há»™', key='guardian_name')
    with col2:
        guardian_relationship = st.text_input('Quan Há»‡ (vá»›i ngÆ°á»i giÃ¡m há»™)', key='guardian_relationship')
    with col3:
        guardian_contact = st.text_input('LiÃªn Há»‡ (ngÆ°á»i giÃ¡m há»™)', key='guardian_contact')

    # HÃ ng thÃ´ng tin ngÆ°á»i hÆ°á»›ng dáº«n
    col4, col5, col6 = st.columns(3)
    with col4:
        chaperone_name = st.text_input('TÃªn NgÆ°á»i HÆ°á»›ng Dáº«n', key='chaperone_name')
    with col5:
        chaperone_relationship = st.text_input('Quan Há»‡ (vá»›i ngÆ°á»i hÆ°á»›ng dáº«n)', key='chaperone_relationship')
    with col6:
        chaperone_contact = st.text_input('LiÃªn Há»‡ (ngÆ°á»i hÆ°á»›ng dáº«n)', key='chaperone_contact')

# Triá»ƒn khai Tab Chá»¯ kÃ½
with tabs[4]:
    st.header("Chá»¯ KÃ½ Cuá»‘i CÃ¹ng")

    # Äoáº¡n vÄƒn giáº£i thÃ­ch
    st.markdown('<p style="color: black; font-size: small;">Náº¿u canvas chá»¯ kÃ½ khÃ´ng hiá»ƒn thá»‹, hÃ£y nháº¥n nÃºt [Táº£i Canvas Chá»¯ KÃ½]</p>', unsafe_allow_html=True)

    # Sá»­a Ä‘á»•i cÃ¡c hÃ m reset canvas
    def reset_student_canvas():
        st.session_state.student_canvas_key += 1
        st.session_state.student_signature_img = None
        st.session_state.student_canvas_initialized = True

    def reset_guardian_canvas():
        st.session_state.guardian_canvas_key += 1
        st.session_state.guardian_signature_img = None
        st.session_state.guardian_canvas_initialized = True

    # Logic khá»Ÿi táº¡o tá»± Ä‘á»™ng
    if not st.session_state.student_canvas_initialized:
        reset_student_canvas()
        st.rerun()

    if not st.session_state.guardian_canvas_initialized:
        reset_guardian_canvas()
        st.rerun()

    # Pháº§n Chá»¯ kÃ½ cá»§a Há»c sinh
    st.markdown("### Chá»¯ KÃ½ Há»c Sinh")
    col1, col2 = st.columns([4, 1])

    with col1:
        canvas_key = f"student_signature_canvas_{st.session_state.student_canvas_key}"
        student_canvas = st_canvas(
            fill_color="rgba(0, 0, 0, 0)",
            stroke_width=2,
            stroke_color="#000000",
            background_color="rgba(0, 0, 0, 0)",
            height=150,
            width=400,
            drawing_mode="freedraw",
            key=canvas_key
        )

        if student_canvas.image_data is not None:
            st.session_state.student_signature_img = student_canvas.image_data

    with col2:
        if st.button("Táº£i Canvas Chá»¯ KÃ½", key=f"reset_student_btn_{st.session_state.student_canvas_key}"):
            reset_student_canvas()
            st.rerun()

    if st.session_state.student_signature_img is not None:
        st.markdown("âœ… HÃ£y nháº­p chá»¯ kÃ½ cá»§a há»c sinh.")

    # ThÃªm Ä‘Æ°á»ng phÃ¢n cÃ¡ch
    st.markdown("---")

    # Pháº§n Chá»¯ kÃ½ cá»§a NgÆ°á»i GiÃ¡m Há»™
    st.markdown("### Chá»¯ KÃ½ NgÆ°á»i GiÃ¡m Há»™")
    col3, col4 = st.columns([4, 1])

    with col3:
        # Sá»­a Ä‘á»•i key canvas cá»§a ngÆ°á»i giÃ¡m há»™ theo cÃ¡ch tÆ°Æ¡ng tá»±
        guardian_canvas_key = f"guardian_signature_canvas_{st.session_state.guardian_canvas_key}"
        guardian_canvas = st_canvas(
            fill_color="rgba(0, 0, 0, 0)",
            stroke_width=2,
            stroke_color="#000000",
            background_color="rgba(0, 0, 0, 0)",
            height=150,
            width=400,
            drawing_mode="freedraw",
            key=guardian_canvas_key
        )

        if guardian_canvas.image_data is not None:
            st.session_state.guardian_signature_img = guardian_canvas.image_data

    with col4:
        if st.button("Táº£i Canvas Chá»¯ KÃ½", key=f"reset_guardian_btn_{st.session_state.guardian_canvas_key}"):
            reset_guardian_canvas()
            st.rerun()

    if st.session_state.guardian_signature_img is not None:
        st.markdown("âœ… HÃ£y nháº­p chá»¯ kÃ½ cá»§a ngÆ°á»i giÃ¡m há»™.")

    # XÃ¡c nháº­n HoÃ n thÃ nh Chá»¯ kÃ½
    if st.session_state.student_signature_img is not None and st.session_state.guardian_signature_img is not None:
        st.success("âœ… Sau khi hoÃ n thÃ nh táº¥t cáº£ chá»¯ kÃ½, hÃ£y chuyá»ƒn sang bÆ°á»›c tiáº¿p theo.")

# Tab XÃ¡c nháº­n Ä‘Æ¡n Ä‘Äƒng kÃ½
with tabs[5]:
    st.header("XÃ¡c Nháº­n ÄÆ¡n ÄÄƒng KÃ½")

    # Há»™p giáº£i thÃ­ch gá»n gÃ ng
    st.markdown("""
        <div style="
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px auto;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        ">
            <div style="color: #1f1f1f; font-size: 1.1em; margin-bottom: 8px;">
                ğŸ“„ Táº£i file PDF Ä‘Ã£ táº¡o vÃ  ná»™p cho giÃ¡o viÃªn chá»§ nhiá»‡m
            </div>
            <div style="color: #666; font-size: 0.9em;">
                Xem láº¡i Ä‘Æ¡n Ä‘Äƒng kÃ½ vÃ  táº£i xuá»‘ng
            </div>
        </div>
    """, unsafe_allow_html=True)

    # Thiáº¿t láº­p Ä‘Æ°á»ng dáº«n file áº£nh
    img_path = IMAGE_DIR / "studywork001.png"
    extra_img_path = IMAGE_DIR / "studywork002.png"  # áº¢nh máº«u phá»¥ lá»¥c

    # Kiá»ƒm tra tÃ­nh há»£p lá»‡ cá»§a dá»¯ liá»‡u báº¯t buá»™c
    required_fields = [
        "student_name", "student_grade", "student_class", "student_number",
        "start_date", "end_date", "attendance_start_date", "attendance_end_date", "plans"
    ]
    missing_fields = [field for field in required_fields if field not in st.session_state or not st.session_state[field]]

    if missing_fields:
        st.error(f"CÃ¡c má»¥c báº¯t buá»™c sau cÃ²n thiáº¿u: {', '.join(missing_fields)}")
    else:
        try:
            # XÃ¡c minh sá»± tá»“n táº¡i cá»§a file áº£nh
            if not img_path.exists():
                st.error("KhÃ´ng tÃ¬m tháº¥y áº£nh máº«u Ä‘Æ¡n Ä‘Äƒng kÃ½.")
                st.stop()

            # Táº£i vÃ  thiáº¿t láº­p áº£nh
            image = Image.open(img_path).convert("RGBA")
            draw = ImageDraw.Draw(image)

            if font_path is None:
                st.error("""
                KhÃ´ng tÃ¬m tháº¥y file font.
                Báº¡n cÃ³ thá»ƒ giáº£i quyáº¿t báº±ng má»™t trong cÃ¡c cÃ¡ch sau:
                1. CÃ i Ä‘áº·t font AppleGothic trÃªn Mac OS
                2. ThÃªm file AppleGothic.ttf vÃ o thÆ° má»¥c fonts cá»§a dá»± Ã¡n
                """)
                st.stop()

            font = ImageFont.truetype(str(font_path), size=55)

            # Logic tÃ­nh toÃ¡n ngÃ y (há»c táº­p tráº£i nghiá»‡m ngoÃ i trÆ°á»ng)
            start_date = st.session_state.get("start_date")
            end_date = st.session_state.get("end_date")
            
            today = date.today()  # NgÃ y ná»™p
            submit_date_formatted = today.strftime("%Yë…„ %mì›” %dì¼")

            try:
                if isinstance(start_date, datetime.date) and isinstance(end_date, datetime.date):
                    duration = (end_date - start_date).days + 1  # Bao gá»“m ngÃ y báº¯t Ä‘áº§u vÃ  ngÃ y káº¿t thÃºc
                    start_date_formatted = start_date.strftime("%Yë…„ %mì›” %dì¼")
                    end_date_formatted = end_date.strftime("%Yë…„ %mì›” %dì¼")
                else:
                    raise ValueError("NgÃ y báº¯t Ä‘áº§u vÃ  ngÃ y káº¿t thÃºc khÃ´ng Ä‘Ãºng Ä‘á»‹nh dáº¡ng ngÃ y.")
            except Exception as e:
                st.error(f"Lá»—i trong quÃ¡ trÃ¬nh tÃ­nh toÃ¡n ngÃ y: {e}")
                st.stop()

            # TÃ­nh toÃ¡n thá»i gian Ä‘Æ°á»£c cÃ´ng nháº­n Ä‘i há»c (loáº¡i trá»« ngÃ y lá»…)
            attendance_start_date = st.session_state.get("attendance_start_date")
            attendance_end_date = st.session_state.get("attendance_end_date")

            try:
                kr_holidays = holidays.KR(years=attendance_start_date.year)  # Láº¥y danh sÃ¡ch ngÃ y lá»… cá»§a HÃ n Quá»‘c trong nÄƒm
                attendance_days = [
                    attendance_start_date + timedelta(days=i)
                    for i in range((attendance_end_date - attendance_start_date).days + 1)
                    if (attendance_start_date + timedelta(days=i)) not in kr_holidays  # Loáº¡i bá» ngÃ y lá»…
                    and (attendance_start_date + timedelta(days=i)).weekday() < 5  # Loáº¡i bá» ngÃ y cuá»‘i tuáº§n (thá»© 7 vÃ  CN)
                ]
                attendance_duration = len(attendance_days)
                attendance_start_formatted = attendance_start_date.strftime("%Yë…„ %mì›” %dì¼")
                attendance_end_formatted = attendance_end_date.strftime("%Yë…„ %mì›” %dì¼")
            except Exception as e:
                st.error(f"Lá»—i trong quÃ¡ trÃ¬nh tÃ­nh toÃ¡n thá»i gian Ä‘Æ°á»£c cÃ´ng nháº­n Ä‘i há»c: {e}")
                st.stop()

            # Váº½ thÃ´ng tin cÆ¡ báº£n lÃªn áº£nh
            draw.text((770, 590), st.session_state.get("student_name", ""), fill="black", font=font)  # TÃªn há»c sinh
            draw.text((1860, 590), st.session_state.get("student_grade", "").replace('í•™ë…„', ''), fill="black", font=font)  # Lá»›p (bá» chá»¯ "í•™ë…„")
            draw.text((2050, 590), st.session_state.get("student_class", "").replace('ë°˜', ''), fill="black", font=font)  # Tá»• (bá» chá»¯ "ë°˜")
            draw.text((2200, 590), str(st.session_state.get("student_number", "")), fill="black", font=font)  # Sá»‘ thá»© tá»±

            # Váº½ thá»i gian há»c táº­p tráº£i nghiá»‡m ngoÃ i trÆ°á»ng
            draw.text((1250, 690), start_date_formatted, fill="black", font=font)  # NgÃ y báº¯t Ä‘áº§u
            draw.text((1840, 690), end_date_formatted, fill="black", font=font)  # NgÃ y káº¿t thÃºc
            draw.text((2400, 690), f"{duration}", fill="black", font=font)  # Tá»•ng sá»‘ ngÃ y

            # Váº½ thá»i gian Ä‘Æ°á»£c cÃ´ng nháº­n Ä‘i há»c
            draw.text((1250, 800), attendance_start_formatted, fill="black", font=font)  # NgÃ y báº¯t Ä‘áº§u
            draw.text((1850, 800), attendance_end_formatted, fill="black", font=font)  # NgÃ y káº¿t thÃºc
            draw.text((2400, 800), f"{attendance_duration}", fill="black", font=font)  # Tá»•ng sá»‘ ngÃ y
            draw.text((1250, 3270), submit_date_formatted, fill="black", font=font)  # NgÃ y ná»™p Ä‘Æ¡n

            # Äiá»u chá»‰nh vá»‹ trÃ­ cá»§a '0' theo hÃ¬nh thá»©c há»c táº­p
            learning_type = st.session_state.get("learning_type", "")  # Láº¥y hÃ¬nh thá»©c há»c táº­p Ä‘Ã£ chá»n
            if learning_type == "ê°€ì¡± ë™ë°˜ ì—¬í–‰":  # Du lá»‹ch cÃ¹ng gia Ä‘Ã¬nh
                draw.text((940, 875), "0", fill="black", font=font)
            elif learning_type == "ì¹œì¸ì²™ ê²½ì¡°ì‚¬ ì°¸ì„ ë° ë°©ë¬¸":  # Tham dá»± vÃ  thÄƒm viáº¿ng sá»± kiá»‡n gia Ä‘Ã¬nh
                draw.text((1700, 875), "0", fill="black", font=font)
            elif learning_type == "ìœ ì  íƒë°©":  # KhÃ¡m phÃ¡ di tÃ­ch
                draw.text((2075, 875), "0", fill="black", font=font)
            elif learning_type == "ë¬¸í•™ ê¸°í–‰":  # Du lá»‹ch vÄƒn há»c
                draw.text((2450, 875), "0", fill="black", font=font)
            elif learning_type == "ìš°ë¦¬ ë¬¸í™” ë° ì„¸ê³„ ë¬¸í™” ì²´í—˜":  # Tráº£i nghiá»‡m vÄƒn hÃ³a trong nÆ°á»›c vÃ  tháº¿ giá»›i
                draw.text((1225, 945), "0", fill="black", font=font)
            elif learning_type == "êµ­í†  ìˆœë¡€":  # HÃ nh hÆ°Æ¡ng
                draw.text((1580, 945), "0", fill="black", font=font)
            elif learning_type == "ìì—° íƒì‚¬":  # KhÃ¡m phÃ¡ thiÃªn nhiÃªn
                draw.text((1970, 945), "0", fill="black", font=font)
            elif learning_type == "ì§ì—… ì²´í—˜":  # Tráº£i nghiá»‡m nghá» nghiá»‡p
                draw.text((2340, 945), "0", fill="black", font=font)
            elif learning_type == "ê¸°íƒ€":  # CÃ¡c hÃ¬nh thá»©c khÃ¡c
                draw.text((2600, 945), "0", fill="black", font=font)
            else:
                draw.text((300, 460), "í•™ìŠµ í˜•íƒœë¥¼ ì„ íƒí•˜ì„¸ìš”", fill="red", font=font)  # Nháº¯c nhá»Ÿ chá»n hÃ¬nh thá»©c há»c táº­p

            # Váº½ cÃ¡c thÃ´ng tin khÃ¡c
            draw.text((580, 1050), st.session_state.get("purpose", ""), fill="black", font=font)  # Má»¥c Ä‘Ã­ch
            draw.text((580, 1200), st.session_state.get("destination", ""), fill="black", font=font)  # Äá»‹a Ä‘iá»ƒm
            draw.text((710, 1330), st.session_state.get("guardian_name", ""), fill="black", font=font)  # TÃªn ngÆ°á»i giÃ¡m há»™
            draw.text((2150, 1330), st.session_state.get("guardian_contact", ""), fill="black", font=font)  # LiÃªn há»‡ ngÆ°á»i giÃ¡m há»™
            draw.text((710, 1470), st.session_state.get("chaperone_name", ""), fill="black", font=font)  # TÃªn ngÆ°á»i hÆ°á»›ng dáº«n
            draw.text((2150, 1470), st.session_state.get("chaperone_contact", ""), fill="black", font=font)  # LiÃªn há»‡ ngÆ°á»i hÆ°á»›ng dáº«n
            draw.text((1540, 1330), st.session_state.get("guardian_relationship", ""), fill="black", font=font)  # Quan há»‡ vá»›i ngÆ°á»i giÃ¡m há»™
            draw.text((1540, 1470), st.session_state.get("chaperone_relationship", ""), fill="black", font=font)  # Quan há»‡ vá»›i ngÆ°á»i hÆ°á»›ng dáº«n
            draw.text((2250, 3400), st.session_state.get("student_name", ""), fill="black", font=font)  # TÃªn há»c sinh (chá»— kÃ½ tÃªn)
            draw.text((2250, 3530), st.session_state.get("guardian_name", ""), fill="black", font=font)  # TÃªn ngÆ°á»i giÃ¡m há»™ (chá»— kÃ½ tÃªn)

            def add_signatures(image):
                """HÃ m há»— trá»£ thÃªm hÃ¬nh áº£nh chá»¯ kÃ½ vÃ o Ä‘Æ¡n Ä‘Äƒng kÃ½"""
                if 'student_signature_img' in st.session_state:
                    student_signature_img = Image.fromarray(np.array(st.session_state['student_signature_img']).astype('uint8')).convert("RGBA")
                    new_size = (int(student_signature_img.width), int(student_signature_img.height))  # Láº¥y kÃ­ch thÆ°á»›c má»›i
                    student_signature_img = student_signature_img.resize(new_size, Image.Resampling.LANCZOS)  # Thay Ä‘á»•i kÃ­ch thÆ°á»›c Ä‘á»ƒ Ä‘áº£m báº£o cháº¥t lÆ°á»£ng
                    image.paste(student_signature_img, (2400, 3350), student_signature_img)  # DÃ¡n chá»¯ kÃ½ vÃ o áº£nh

                if 'guardian_signature_img' in st.session_state:
                    guardian_signature_img = Image.fromarray(np.array(st.session_state['guardian_signature_img']).astype('uint8')).convert("RGBA")
                    new_size = (int(guardian_signature_img.width), int(guardian_signature_img.height))  # Láº¥y kÃ­ch thÆ°á»›c má»›i
                    guardian_signature_img = guardian_signature_img.resize(new_size, Image.Resampling.LANCZOS)  # Thay Ä‘á»•i kÃ­ch thÆ°á»›c Ä‘á»ƒ Ä‘áº£m báº£o cháº¥t lÆ°á»£ng
                    image.paste(guardian_signature_img, (2400, 3500), guardian_signature_img)  # DÃ¡n chá»¯ kÃ½ vÃ o áº£nh

            # Khá»Ÿi táº¡o biáº¿n Ä‘á»ƒ xá»­ lÃ½ dá»¯ liá»‡u káº¿ hoáº¡ch há»c táº­p
            x_start, y_start = 580, 1570  # Vá»‹ trÃ­ báº¯t Ä‘áº§u cá»§a Ã´ Ä‘áº§u tiÃªn
            max_y = 2900
            font_size = 50
            min_font_size = 30
            extra_needed = False  # Biáº¿n Ä‘Ã¡nh dáº¥u cÃ³ cáº§n phá»¥ lá»¥c hay khÃ´ng
            first_section_plans = []  # Káº¿ hoáº¡ch cho pháº§n Ä‘áº§u tiÃªn (trang chÃ­nh)
            second_section_plans = []  # Káº¿ hoáº¡ch cho pháº§n thá»© hai (trang chÃ­nh)
            remaining_plans = []  # Káº¿ hoáº¡ch cÃ²n láº¡i (dÃ nh cho phá»¥ lá»¥c náº¿u cáº§n)

            if 'plans' in st.session_state and isinstance(st.session_state.plans, dict):
                # Táº¡o text káº¿ hoáº¡ch tá»•ng thá»ƒ
                start_date = st.session_state.start_date
                sorted_days = sorted(
                    [(day_key, (start_date + timedelta(days=int(''.join(filter(str.isdigit, day_key))) - 1)))
                     for day_key in st.session_state.plans.keys()],
                    key=lambda x: x[1]  # Sáº¯p xáº¿p theo ngÃ y
                )

                # Chia káº¿ hoáº¡ch tá»•ng thá»ƒ thÃ nh hai pháº§n
                first_section_plans = []
                second_section_plans = []
                total_plans = []

                # ThÃªm táº¥t cáº£ cÃ¡c káº¿ hoáº¡ch vÃ o total_plans vÃ  sáº¯p xáº¿p theo thá»i gian
                for day_key, date in sorted_days:
                    plans = st.session_state.plans.get(day_key, [])
                    for i, plan in enumerate(plans):
                        plan_data = {
                            'day': day_key if i == 0 else '',  # Chá»‰ hiá»ƒn thá»‹ ngÃ y á»Ÿ má»¥c Ä‘áº§u tiÃªn cá»§a má»—i ngÃ y
                            'time': plan.get('ì‹œê°„', ''),  # Thá»i gian
                            'location': plan.get('ì¥ì†Œ', ''),  # Äá»‹a Ä‘iá»ƒm
                            'activity': plan.get('í™œë™ë‚´ìš©', '')  # Ná»™i dung hoáº¡t Ä‘á»™ng
                        }
                        total_plans.append(plan_data)

                # Chia káº¿ hoáº¡ch tá»•ng thá»ƒ thÃ nh hai pháº§n
                half_length = len(total_plans) // 2
                if len(total_plans) % 2 != 0:
                    half_length += 1  # Náº¿u sá»‘ lÆ°á»£ng káº¿ hoáº¡ch láº», pháº§n Ä‘áº§u tiÃªn sáº½ cÃ³ nhiá»u hÆ¡n 1 káº¿ hoáº¡ch

                first_section_plans = total_plans[:half_length]
                second_section_plans = total_plans[half_length:]

                # Thiáº¿t láº­p vá»‹ trÃ­ báº¯t Ä‘áº§u cá»™t vÃ  khoáº£ng cÃ¡ch dÃ²ng
                # Tá»a Ä‘á»™ cá»§a pháº§n Ä‘áº§u tiÃªn (cá»™t bÃªn trÃ¡i)
                x_time_first = 800  # Vá»‹ trÃ­ báº¯t Ä‘áº§u cá»§a thá»i gian
                x_location_first = 1000  # Vá»‹ trÃ­ báº¯t Ä‘áº§u cá»§a Ä‘á»‹a Ä‘iá»ƒm
                x_activity_first = 1300  # Vá»‹ trÃ­ báº¯t Ä‘áº§u cá»§a ná»™i dung hoáº¡t Ä‘á»™ng

                # Tá»a Ä‘á»™ cá»§a pháº§n thá»© hai (cá»™t bÃªn pháº£i)
                x_time_second = 1800  # Vá»‹ trÃ­ báº¯t Ä‘áº§u cá»§a thá»i gian
                x_location_second = 2000  # Vá»‹ trÃ­ báº¯t Ä‘áº§u cá»§a Ä‘á»‹a Ä‘iá»ƒm
                x_activity_second = 2300  # Vá»‹ trÃ­ báº¯t Ä‘áº§u cá»§a ná»™i dung hoáº¡t Ä‘á»™ng

                line_height = 70  # Chiá»u cao cá»§a má»—i dÃ²ng
                current_y = y_start  # Vá»‹ trÃ­ y hiá»‡n táº¡i

                # Váº½ pháº§n Ä‘áº§u tiÃªn (cá»™t bÃªn trÃ¡i)
                current_y = y_start
                current_day = None  # LÆ°u ngÃ y hiá»‡n táº¡i Ä‘á»ƒ trÃ¡nh láº·p láº¡i
                x_start_first = 580  # Tá»a Ä‘á»™ X báº¯t Ä‘áº§u cá»§a cá»™t bÃªn trÃ¡i

                for plan in first_section_plans:
                    if current_y >= max_y:  # Náº¿u vÆ°á»£t quÃ¡ chiá»u cao tá»‘i Ä‘a, chuyá»ƒn sang phá»¥ lá»¥c
                        remaining_plans.append(plan)
                        extra_needed = True
                        continue

                    if plan['day'] and plan['day'] != current_day:  # Náº¿u báº¯t Ä‘áº§u má»™t ngÃ y má»›i
                        if current_y != y_start:  # Náº¿u khÃ´ng pháº£i ngÃ y Ä‘áº§u tiÃªn, thÃªm khoáº£ng cÃ¡ch
                            current_y += line_height
                        current_day = plan['day']
                        draw.text((x_start_first, current_y), current_day, fill="black", font=font)  # Hiá»ƒn thá»‹ ngÃ y
                        current_y += line_height  # Xuá»‘ng dÃ²ng sau khi hiá»ƒn thá»‹ ngÃ y

                    # Thá»i gian/Äá»‹a Ä‘iá»ƒm/Ná»™i dung hoáº¡t Ä‘á»™ng báº¯t Ä‘áº§u á»Ÿ cÃ¹ng tá»a Ä‘á»™ X vá»›i ngÃ y
                    draw.text((x_time_first, current_y), plan['time'], fill="black", font=font)  # Thá»i gian
                    draw.text((x_location_first, current_y), plan['location'], fill="black", font=font)  # Äá»‹a Ä‘iá»ƒm
                    draw.text((x_activity_first, current_y), plan['activity'], fill="black", font=font)  # Ná»™i dung hoáº¡t Ä‘á»™ng
                    current_y += line_height

                # Váº½ pháº§n thá»© hai (cá»™t bÃªn pháº£i)
                current_y = y_start
                current_day = None
                x_start_second = 1600  # Tá»a Ä‘á»™ X báº¯t Ä‘áº§u cá»§a cá»™t bÃªn pháº£i

                for plan in second_section_plans:
                    if current_y >= max_y:  # Náº¿u vÆ°á»£t quÃ¡ chiá»u cao tá»‘i Ä‘a, chuyá»ƒn sang phá»¥ lá»¥c
                        remaining_plans.append(plan)
                        extra_needed = True
                        continue

                    if plan['day'] and plan['day'] != current_day:  # Náº¿u báº¯t Ä‘áº§u má»™t ngÃ y má»›i
                        if current_y != y_start:  # Náº¿u khÃ´ng pháº£i ngÃ y Ä‘áº§u tiÃªn, thÃªm khoáº£ng cÃ¡ch
                            current_y += line_height
                        current_day = plan['day']
                        draw.text((x_start_second, current_y), current_day, fill="black", font=font)  # Hiá»ƒn thá»‹ ngÃ y
                        current_y += line_height  # Xuá»‘ng dÃ²ng sau khi hiá»ƒn thá»‹ ngÃ y

                    # Thá»i gian/Äá»‹a Ä‘iá»ƒm/Ná»™i dung hoáº¡t Ä‘á»™ng báº¯t Ä‘áº§u á»Ÿ cÃ¹ng tá»a Ä‘á»™ X vá»›i ngÃ y
                    draw.text((x_time_second, current_y), plan['time'], fill="black", font=font)  # Thá»i gian
                    draw.text((x_location_second, current_y), plan['location'], fill="black", font=font)  # Äá»‹a Ä‘iá»ƒm
                    draw.text((x_activity_second, current_y), plan['activity'], fill="black", font=font)  # Ná»™i dung hoáº¡t Ä‘á»™ng
                    current_y += line_height

                # Náº¿u cáº§n phá»¥ lá»¥c, táº¡o áº£nh phá»¥ lá»¥c
                if extra_needed and remaining_plans:
                    extra_image = Image.open(extra_img_path).convert("RGBA")  # Má»Ÿ áº£nh phá»¥ lá»¥c
                    extra_draw = ImageDraw.Draw(extra_image)  # Táº¡o Ä‘á»‘i tÆ°á»£ng Ä‘á»ƒ váº½ lÃªn áº£nh phá»¥ lá»¥c

                    # Äiá»u chá»‰nh vá»‹ trÃ­ báº¯t Ä‘áº§u cho phá»¥ lá»¥c
                    current_y = 700  # Báº¯t Ä‘áº§u dÆ°á»›i tiÃªu Ä‘á» cá»§a phá»¥ lá»¥c

                    # Viáº¿t tuáº§n tá»± vÃ o phá»¥ lá»¥c, báº¯t Ä‘áº§u tá»« bÃªn trÃ¡i
                    x_day = 580  # Vá»‹ trÃ­ X cá»§a ngÃ y
                    x_time = 800  # Vá»‹ trÃ­ X cá»§a thá»i gian
                    x_location = 1000  # Vá»‹ trÃ­ X cá»§a Ä‘á»‹a Ä‘iá»ƒm
                    x_activity = 1200  # Vá»‹ trÃ­ X cá»§a ná»™i dung hoáº¡t Ä‘á»™ng

                    # Viáº¿t táº¥t cáº£ cÃ¡c káº¿ hoáº¡ch cÃ²n láº¡i vÃ o phá»¥ lá»¥c
                    for plan in remaining_plans:
                        extra_draw.text((x_day, current_y), plan['day'], fill="black", font=font)  # NgÃ y
                        extra_draw.text((x_time, current_y), plan['time'], fill="black", font=font)  # Thá»i gian
                        extra_draw.text((x_location, current_y), plan['location'], fill="black", font=font)  # Äá»‹a Ä‘iá»ƒm
                        extra_draw.text((x_activity, current_y), plan['activity'], fill="black", font=font)  # Ná»™i dung hoáº¡t Ä‘á»™ng
                        current_y += line_height

                        # Dá»«ng náº¿u Ä‘áº¡t Ä‘áº¿n cuá»‘i phá»¥ lá»¥c
                        if current_y >= 3000:  # Giá»›i háº¡n chiá»u cao tá»‘i Ä‘a cá»§a phá»¥ lá»¥c
                            st.warning("Káº¿ hoáº¡ch quÃ¡ nhiá»u, má»™t sá»‘ ná»™i dung khÃ´ng Ä‘Æ°á»£c Ä‘Æ°a vÃ o phá»¥ lá»¥c.")
                            break

            # ThÃªm chá»¯ kÃ½ vÃ o áº£nh
            add_signatures(image)

            # Hiá»ƒn thá»‹ áº£nh Ä‘Æ¡n Ä‘Äƒng kÃ½
            st.image(image, caption="ÄÆ¡n Ä‘Äƒng kÃ½ (Xem trÆ°á»›c)", use_container_width=True)

            # Náº¿u cáº§n vÃ  cÃ³ phá»¥ lá»¥c, hiá»ƒn thá»‹ áº£nh phá»¥ lá»¥c
            if extra_needed and 'extra_image' in locals():
                st.markdown("### Phá»¥ lá»¥c (Xem trÆ°á»›c)")
                st.image(extra_image, caption="Phá»¥ lá»¥c (Xem trÆ°á»›c)", use_container_width=True)

        except Exception as e:
            st.error(f"Lá»—i khi táº£i áº£nh hoáº·c font: {e}")  # Hiá»ƒn thá»‹ thÃ´ng bÃ¡o lá»—i
            st.stop()

    def generate_pdf():
        try:
            # Sá»­ dá»¥ng thÆ° má»¥c táº¡m thá»i Ä‘á»ƒ lÆ°u áº£nh vÃ  táº¡o PDF
            with tempfile.TemporaryDirectory() as temp_dir:
                temp_dir_path = pathlib.Path(temp_dir)  # Chuyá»ƒn Ä‘á»•i thÃ nh Ä‘á»‘i tÆ°á»£ng Path Ä‘á»ƒ dá»… thao tÃ¡c

                # Thiáº¿t láº­p Ä‘Æ°á»ng dáº«n cho cÃ¡c file áº£nh táº¡m thá»i
                main_image_path = temp_dir_path / "studywork_main.png"
                extra_image_path = temp_dir_path / "studywork_extra.png"

                # LÆ°u cÃ¡c file áº£nh (áº£nh chÃ­nh luÃ´n Ä‘Æ°á»£c lÆ°u)
                image.save(main_image_path)
                if extra_needed:  # Náº¿u cáº§n phá»¥ lá»¥c thÃ¬ má»›i lÆ°u
                    extra_image.save(extra_image_path)

                # Danh sÃ¡ch cÃ¡c file áº£nh Ä‘á»ƒ táº¡o PDF
                image_list = [str(main_image_path)]  # LuÃ´n cÃ³ áº£nh chÃ­nh
                if extra_needed:  # Náº¿u cáº§n phá»¥ lá»¥c thÃ¬ thÃªm vÃ o danh sÃ¡ch
                    image_list.append(str(extra_image_path))

                # Chuyá»ƒn Ä‘á»•i áº£nh thÃ nh PDF sá»­ dá»¥ng thÆ° viá»‡n img2pdf
                pdf_bytes = img2pdf.convert(image_list)

                # Táº¡o nÃºt táº£i xuá»‘ng file PDF
                st.download_button(
                    label="Táº£i ÄÆ¡n ÄÄƒng KÃ½ PDF",  # NhÃ£n cá»§a nÃºt
                    data=pdf_bytes,  # Dá»¯ liá»‡u PDF
                    file_name="êµì™¸ì²´í—˜í•™ìŠµ_ì‹ ì²­ì„œ.pdf",  # TÃªn file máº·c Ä‘á»‹nh khi táº£i
                    mime="application/pdf"  # Loáº¡i MIME (Multipurpose Internet Mail Extensions)
                )

        except Exception as e:
            st.error(f"PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")  # BÃ¡o lá»—i náº¿u cÃ³

    # Táº¡o nÃºt kÃ­ch hoáº¡t quÃ¡ trÃ¬nh táº¡o vÃ  táº£i file PDF
    if st.button("Táº¡o vÃ  Táº£i File PDF", key="pdf_download_button"):
        generate_pdf()  # Gá»i hÃ m generate_pdf() Ä‘á»ƒ táº¡o vÃ  táº£i file PDF

# ThÃªm footer báº±ng HTML vÃ  CSS
footer = """
    <style>
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #f1f1f1;
            text-align: center;
            padding: 10px;
            font-size: 14px;
        }
    </style>
    <div class="footer">
        NgÆ°á»i táº¡o: ë°•ê¸°ìœ¤ (Park Ki-yoon)
    </div>
"""
st.markdown(footer, unsafe_allow_html=True)  # ChÃ¨n footer vÃ o á»©ng dá»¥ng